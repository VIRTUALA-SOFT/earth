<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <!-- viewport-fit=cover asegura que ocupe toda la pantalla en m√≥viles con notch -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ULULATO ‚Äì Earth Experience</title>
  
  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Iconos Material Symbols -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="https://cdn2.ululato.com/img/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cdn2.ululato.com/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cdn2.ululato.com/img/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://cdn2.ululato.com/img/apple-touch-icon.png">
  
  <!-- 1. IMPORT MAP (Primero) -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <!-- Animaciones -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <style>
    :root {
      --primary: #ffd700;       
      --accent: #00f3ff;        
      --glass-bg: rgba(10, 15, 25, 0.90);
      --glass-border: 1px solid rgba(255, 255, 255, 0.15);
      --text-main: #ffffff;
      --text-secondary: #aaaaaa;
    }

    body, html { margin: 0; padding: 0; overflow: hidden; background: #000000; font-family: 'Montserrat', sans-serif; width: 100%; height: 100%; height: 100dvh; }
    #app { position: relative; width: 100%; height: 100%; }
    #globe { width: 100%; height: 100%; display: block; outline: none; }

    /* --- ESTILOS GENERALES UI --- */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: var(--glass-border); border-radius: 16px; padding: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7); color: var(--text-main);
      transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1); box-sizing: border-box; 
    }

    /* BOT√ìN VOLVER */
    .volver-origen { position: absolute; top: 40px; right: 40px; z-index: 20; }
    .back-link {
        text-decoration: none; color: #B0B3B8; font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase;
        display: flex; align-items: center; gap: 5px; padding: 8px 16px; border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.5); transition: 0.3s; cursor: pointer; white-space: nowrap;
    }
    .back-link:hover { border-color: var(--primary); color: var(--primary); }
    body.fade-out { opacity: 0; transition: opacity 0.8s ease; }

    /* BUSCADOR IZQUIERDA */
    #ui-controls {
      position: absolute; top: 40px; left: 40px; width: 320px; z-index: 10;
      display: flex; flex-direction: column; gap: 15px;
    }
    h1 { font-size: 1.1rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin: 0; color: var(--primary); }
    p.subtitle { font-size: 0.8rem; color: var(--text-secondary); margin: 0; font-weight: 300; }

    .search-input {
      width: 100%; padding: 12px 40px 12px 16px; background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; 
      color: white; outline: none; transition: 0.3s; box-sizing: border-box; font-family: inherit;
    }
    .search-input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }
    .search-icon { position: absolute; right: 15px; top: 60%; color: #666; pointer-events: none;}

    .results-list {
      max-height: 0; overflow-y: auto; background: rgba(5, 10, 20, 0.98);
      border-radius: 12px; opacity: 0; transition: 0.3s;
    }
    .results-list.active { max-height: 50vh; opacity: 1; border: var(--glass-border); margin-top: 10px; }
    .result-item { 
      padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); 
      display: flex; flex-direction: column;
    }
    .result-item:hover { background: rgba(255,255,255,0.1); }
    .item-name { font-weight: 600; color: #fff; font-size: 0.95rem; }
    .item-region { font-size: 0.75rem; color: var(--accent); margin-top: 2px; text-transform: uppercase; letter-spacing: 1px; }

    /* --- TARJETA DERECHA --- */
    #info-card {
      position: absolute; bottom: 40px; right: 40px; width: 360px;
      transform: translateX(50px); opacity: 0; pointer-events: none; z-index: 10;
      display: flex; flex-direction: column; max-height: 80vh; overflow: hidden;
    }
    #info-card.active { transform: translateX(0); opacity: 1; pointer-events: all; }

    /* Media Wrapper */
    .card-media-wrapper {
      width: 100%; height: 180px; margin-bottom: 10px;
      border-radius: 12px; overflow: hidden; position: relative;
      background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
      transition: height 0.3s, opacity 0.3s, margin 0.3s;
    }
    .card-header-media { width: 100%; height: 100%; object-fit: cover; display: block; }

    /* Cabecera Tarjeta */
    .card-header { 
      display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: 10px; padding-bottom: 10px; min-height: 40px; 
      border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer;
    }
    .card-title { font-size: 1.4rem; margin: 0; color: var(--accent); }
    
    .card-controls { display: flex; align-items: center; gap: 12px; }
    .control-btn {
      background: none; border: none; color: #aaa; cursor: pointer; padding: 5px;
      display: flex; align-items: center; justify-content: center; transition: 0.3s;
    }
    .control-btn:hover { color: #fff; transform: scale(1.1); }
    #toggle-icon { transition: transform 0.3s; }

    /* Contenido Interno */
    #card-body-content {
      transition: opacity 0.3s, max-height 0.3s; opacity: 1; max-height: 500px;
      display: flex; flex-direction: column; flex-grow: 1; overflow: hidden;
    }
    .card-content-scroll { 
      overflow-y: auto; margin-bottom: 15px; padding-right: 5px; flex-grow: 1; max-height: 200px;
    }
    .card-content-scroll::-webkit-scrollbar { width: 4px; }
    .card-content-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
    .card-desc { font-size: 0.9rem; line-height: 1.6; color: #ddd; margin: 0; font-weight: 300; }
    
    .btn-action {
      display: block; width: 100%; text-align: center; padding: 12px 0;
      background: rgba(0, 243, 255, 0.1); border: 1px solid var(--accent); color: var(--accent);
      border-radius: 8px; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
      text-decoration: none; transition: 0.3s; flex-shrink: 0; margin-top: auto;
    }
    .btn-action:hover { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0, 243, 255, 0.4); }

    /* ESTADO MINIMIZADO */
    #info-card.minimized #card-body-content { opacity: 0; max-height: 0; margin: 0; }
    #info-card.minimized .card-media-wrapper { height: 0; margin-bottom: 0; opacity: 0; border: none; }
    #info-card.minimized .card-header { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    #info-card.minimized #toggle-icon { transform: rotate(180deg); }

    #tooltip { position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 6px 12px; border-radius: 4px; pointer-events: none; opacity: 0; border: 1px solid #444; z-index: 100; font-size: 0.8rem; transform: translate(-50%, -150%); white-space: nowrap; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; color: var(--primary); font-size: 1.2rem; transition: opacity 0.8s; letter-spacing: 3px; }

    /* RESPONSIVIDAD */
    @media (max-width: 900px) { .back-link { top: 20px; right: 20px; padding: 6px 12px; font-size: 0.65rem; } }
    @media (max-width: 768px) {
      #ui-controls { top: 20px; left: 20px; right: 70px; width: auto; }
      
      /* Tarjeta M√≥vil (Bottom Sheet) */
      #info-card {
        bottom: 0; left: 0; right: 0; width: 100%; max-width: 100%;
        border-radius: 20px 20px 0 0; border-bottom: none; border-left: none; border-right: none;
        max-height: 60dvh; 
        transform: translateY(100%);
        padding-bottom: max(20px, env(safe-area-inset-bottom));
        transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
      }
       /* Aumentar √°rea de toque sin cambiar el tama√±o visual del icono */
      .control-btn {
        padding: 10px; /* M√°s espacio alrededor del icono para el dedo */
        margin-left: 5px; /* Separarlos un poco m√°s entre s√≠ */
      }
      /* Asegurar que la cabecera sea f√°cil de tocar */
      .card-header {
        padding-top: 15px;
        padding-bottom: 15px;
        min-height: 50px; /* Cabecera m√°s alta para facilitar el clic */
      }
      #info-card.active { transform: translateY(0); }
      #info-card.minimized { height: auto; transform: translateY(0); }
      .card-content-scroll { max-height: 150px; }
      h1 { font-size: 0.9rem; }
     .search-icon { top: 50%; transform: translateY(-50%); }
     .search-input { padding: 10px 35px 10px 15px; font-size: 0.9rem; }
        /* 2. AJUSTE DEL BOT√ìN VOLVER (DERECHA) */
      .volver-origen {
        top: 20px;
        right: 20px;
        z-index: 30; /* Asegurar que flote sobre todo */
      }

      /* Transformar en bot√≥n circular solo √≠cono */
      .back-link {
        font-size: 0; /* Oculta el texto "VOLVER AL ORIGEN" */
        padding: 10px; /* Hace el bot√≥n cuadrado/circular */
        border-radius: 50%; /* Lo hace redondo */
        background: rgba(10, 15, 25, 0.8); /* Fondo oscuro para contraste */
        backdrop-filter: blur(10px);
        width: 40px;
        height: 40px;
        justify-content: center;
      }

      /* Asegurar que el √≠cono de la flecha se vea bien */
      .back-link span {
        font-size: 1.2rem;
        margin: 0;
      }
    }
  </style>
</head>
<body>

<div id="loader">CARGANDO MUNDO...</div>
<div id="tooltip"></div>

<!-- Bot√≥n Volver -->
<div class="volver-origen">
    <div class="back-link" onclick="goToHome()">
        <span class="material-symbols-rounded">arrow_back</span>
        VOLVER AL ORIGEN
    </div>
</div>

<div id="app">  
  <!-- BUSCADOR -->
  <div id="ui-controls" class="glass-panel">
    <div>
      <h1>Or√≠genes</h1>
      <p class="subtitle">Explora la sabidur√≠a ancestral</p>
    </div>
    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="Buscar pueblo o regi√≥n...">
      <div class="search-icon">üîç</div>
      <div id="resultsList" class="results-list"></div>
    </div>
  </div>

  <!-- TARJETA INFO -->
  <div id="info-card" class="glass-panel">
    
    <!-- Media (Video/Img) -->
    <div class="card-media-wrapper">
      <img id="card-img" src="" alt="Imagen" class="card-header-media" style="display: none;">
      <video id="card-video" class="card-header-media" style="display: none;" autoplay muted loop playsinline></video>
    </div>
    
    <!-- Cabecera Clickable -->
    <div class="card-header" onclick="toggleCardState()">
      <h2 class="card-title" id="card-title">T√≠tulo</h2>
      <div class="card-controls">
        <!-- Minimizar -->
        <button id="toggle-card" class="control-btn" aria-label="Minimizar">
           <svg id="toggle-icon" width="14" height="8" viewBox="0 0 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 1L7 7L13 1"></path>
           </svg>
        </button>
        <!-- Cerrar -->
        <button id="close-card" class="control-btn" aria-label="Cerrar" onclick="event.stopPropagation(); closeCardLogic();">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="1" y1="1" x2="11" y2="11"></line><line x1="1" y1="11" x2="11" y2="1"></line>
            </svg>
        </button>
      </div>
    </div>
     
    <!-- Contenido -->
    <div id="card-body-content">
      <div class="card-content-scroll">
        <p class="card-desc" id="card-desc">Descripci√≥n...</p>
      </div>
      <a href="#" id="card-link" class="btn-action">VISITAR PUEBLO DE OR√çGEN</a>
    </div>        
  </div>

  <div id="globe"></div>
</div>

<!-- SCRIPTS GLOBALES -->
<script>
  // 1. L√≥gica UI (Minimizar/Cerrar/Volver)
  
  // Volver a Home
  function goToHome() {
      document.body.classList.add('fade-out');
      setTimeout(() => { window.location.href = 'https://prototipo.ululato.com'; }, 800);
  }

  // Toggle Minimizar
  window.toggleCardState = function() {
      const card = document.getElementById('info-card');
      card.classList.toggle('minimized');
  };

  // Cerrar Tarjeta (Dispara evento para el m√≥dulo)
  window.closeCardLogic = function() {
      // Limpia buscador visualmente
      document.getElementById('searchInput').value = '';
      
      // Comunica al m√≥dulo ThreeJS que debe deseleccionar
      window.dispatchEvent(new CustomEvent('close-card-event'));
      
      // Restaura estado minimizado
      setTimeout(() => {
          document.getElementById('info-card').classList.remove('minimized');
      }, 300);
  };
</script>

<!-- L√ìGICA 3D -->
<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { pueblosData } from './data_pueblos.js';

  // --- CONFIGURACI√ìN ESCENA ---
  const container = document.getElementById("globe");
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000000); 
  scene.fog = new THREE.FogExp2(0x000000, 0.02);

  const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 2000);
  camera.position.set(0, 0, 10); // Posici√≥n inicial

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  container.appendChild(renderer.domElement);

  // --- LUCES ---
  scene.add(new THREE.AmbientLight(0xffffff, 0.4));
  scene.add(new THREE.HemisphereLight(0xffffff, 0x000000, 0.8));
  const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
  sunLight.position.set(10, 5, 20);
  scene.add(sunLight);
  const rimLight = new THREE.SpotLight(0x0088ff, 3);
  rimLight.position.set(-15, 10, -5);
  rimLight.lookAt(0,0,0);
  scene.add(rimLight);

  // --- ESTRELLAS ---
  function createRealisticStars() {
    const starGeo1 = new THREE.BufferGeometry();
    const count1 = 15000; 
    const pos1 = new Float32Array(count1 * 3);
    for(let i=0; i<count1*3; i++) pos1[i] = (Math.random()-0.5) * 2000;
    starGeo1.setAttribute('position', new THREE.BufferAttribute(pos1, 3));
    scene.add(new THREE.Points(starGeo1, new THREE.PointsMaterial({color: 0xffffff, size: 0.3, transparent: true, opacity: 0.5})));

    const starGeo2 = new THREE.BufferGeometry();
    const count2 = 4000; 
    const pos2 = new Float32Array(count2 * 3);
    const col2 = new Float32Array(count2 * 3);
    for(let i=0; i<count2; i++) {
        const r = 800 + Math.random()*800; const th=Math.random()*Math.PI*2; const ph=Math.acos(2*Math.random()-1);
        pos2[i*3]=r*Math.sin(ph)*Math.cos(th); pos2[i*3+1]=r*Math.sin(ph)*Math.sin(th); pos2[i*3+2]=r*Math.cos(ph);
        const s = Math.random();
        col2[i*3]=s>0.8?0.9:1; col2[i*3+1]=s>0.8?0.9:1; col2[i*3+2]=1;
    }
    starGeo2.setAttribute('position', new THREE.BufferAttribute(pos2, 3));
    starGeo2.setAttribute('color', new THREE.BufferAttribute(col2, 3));
    scene.add(new THREE.Points(starGeo2, new THREE.PointsMaterial({vertexColors:true, size:0.8, transparent:true, opacity:0.9})));
  }
  createRealisticStars();

  // --- TIERRA ---
  const earthGroup = new THREE.Group();
  scene.add(earthGroup);
  const texLoader = new THREE.TextureLoader();
  const earthMat = new THREE.MeshPhongMaterial({
    map: texLoader.load("https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg"),
    bumpMap: texLoader.load("https://unpkg.com/three-globe/example/img/earth-topology.png"),
    bumpScale: 0.05,
    specularMap: texLoader.load("https://unpkg.com/three-globe/example/img/earth-water.png"),
    specular: new THREE.Color(0x222222), shininess: 15, color: 0xcccccc
  });
  const earth = new THREE.Mesh(new THREE.SphereGeometry(2, 64, 64), earthMat);
  earthGroup.add(earth);
  
  const atmos = new THREE.Mesh(new THREE.SphereGeometry(2.1, 64, 64), new THREE.MeshPhongMaterial({
    color: 0x4488ff, transparent: true, opacity: 0.15, side: THREE.BackSide, blending: THREE.AdditiveBlending, depthWrite: false
  }));
  scene.add(atmos);

  // --- MARCADORES ---
  const markersGroup = new THREE.Group();
  earthGroup.add(markersGroup);

  const matMain = new THREE.MeshBasicMaterial({ color: 0xffd700 });
  const matVillage = new THREE.MeshBasicMaterial({ color: 0xffeba0, transparent: true, opacity: 0.4 });
  const matRing = new THREE.MeshBasicMaterial({ color: 0xffd700, side: THREE.DoubleSide, transparent: true, opacity: 0.4 });
  const geoMain = new THREE.SphereGeometry(0.015, 8, 8);
  const geoVillage = new THREE.SphereGeometry(0.006, 4, 4);
  const geoRing = new THREE.RingGeometry(0.025, 0.035, 16);
  const geoBeam = new THREE.CylinderGeometry(0.005, 0.005, 1, 4);
  geoBeam.translate(0, 0.5, 0);

  function latLonToVector3(lat, lon, radius) {
    const phi = (90 - lat) * (Math.PI / 180);
    const theta = (lon + 180) * (Math.PI / 180);
    return new THREE.Vector3(-(radius * Math.sin(phi) * Math.cos(theta)), (radius * Math.cos(phi)), (radius * Math.sin(phi) * Math.sin(theta)));
  }

  pueblosData.forEach((p, index) => {
    const pos = latLonToVector3(p.lat, p.lon, 2.005);
    const isMain = p.type === 'main';
    const mesh = new THREE.Mesh(isMain ? geoMain : geoVillage, isMain ? matMain.clone() : matVillage.clone());
    mesh.position.copy(pos);
    
    let ring, beam;
    if (isMain) {
        ring = new THREE.Mesh(geoRing, matRing.clone());
        ring.position.copy(pos);
        ring.lookAt(new THREE.Vector3(0,0,0));
        markersGroup.add(ring);

        beam = new THREE.Mesh(geoBeam, new THREE.MeshBasicMaterial({ color: 0x00f3ff, transparent: true, opacity: 0, blending: THREE.AdditiveBlending }));
        beam.position.copy(pos);
        beam.lookAt(new THREE.Vector3(0,0,0));
        beam.rotateX(-Math.PI/2);
        beam.scale.set(1, 0, 1);
        markersGroup.add(beam);
    }
    const hit = new THREE.Mesh(new THREE.SphereGeometry(isMain?0.06:0.03, 4,4), new THREE.MeshBasicMaterial({visible:false}));
    hit.position.copy(pos);
    hit.userData = { id: p.id, uniqueId: index, data: p, mesh, ring, beam, isMain };
    markersGroup.add(mesh);
    markersGroup.add(hit);
  });

  // --- INTERACCI√ìN ---
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true; controls.dampingFactor = 0.05;
  controls.autoRotate = true; controls.autoRotateSpeed = 0.5;
  controls.minDistance = 2.5; controls.maxDistance = 20;

  let currentSelectionTween = null;

  function selectPueblo(id) {
    if(currentSelectionTween) { currentSelectionTween.kill(); currentSelectionTween = null; }

    markersGroup.children.forEach(child => {
      if (!child.userData.data) return;
      const u = child.userData;
      
      if (u.id === id && u.isMain) {
          u.mesh.material.color.setHex(0x00f3ff);
          if(u.ring) {
            u.ring.material.color.setHex(0x00f3ff); u.ring.material.opacity = 1;
            currentSelectionTween = gsap.to(u.ring.scale, { x: 2.5, y: 2.5, duration: 1.2, yoyo: true, repeat: -1, ease: "sine.inOut" });
            gsap.to(u.ring.material, { opacity: 0.2, duration: 1.2, yoyo: true, repeat: -1 });
          }
          if(u.beam) { gsap.to(u.beam.scale, { y: 2.0, duration: 1 }); gsap.to(u.beam.material, { opacity: 0.8, duration: 0.5 }); }
          
          showInfoCard(u.data);
          
          // UX: Iniciar minimizado para dejar ver el viaje
          const card = document.getElementById('info-card');
          card.classList.add('minimized'); 
          card.classList.add('active');

      } else {
          u.mesh.material.color.setHex(u.isMain ? 0xffd700 : 0xffeba0);
          if(u.ring) {
            gsap.killTweensOf(u.ring.scale); gsap.killTweensOf(u.ring.material);
            u.ring.material.color.setHex(0xffd700); u.ring.material.opacity = id ? 0.1 : 0.4;
            gsap.to(u.ring.scale, { x: 1, y: 1, duration: 0.5 });
          }
          if(u.beam) { gsap.to(u.beam.scale, { y: 0, duration: 0.3 }); gsap.to(u.beam.material, { opacity: 0, duration: 0.3 }); }
      }
    });

    if(!id) {
      controls.autoRotate = true;
      document.getElementById('info-card').classList.remove('active');
    } else {
      controls.autoRotate = false;
      const target = pueblosData.find(e => e.id === id && e.type === 'main');
      if(target) focusCamera(target.lat, target.lon);
    }
  }

  // Escuchar evento de cierre desde el HTML
  window.addEventListener('close-card-event', () => {
      selectPueblo(null);
  });

function focusCamera(lat, lon) {
    const pVec = latLonToVector3(lat, lon, 1).normalize();
    const targetDist = 4.5; 
    const endPos = pVec.clone().multiplyScalar(targetDist);
    
    gsap.to(camera.position, { 
        duration: 3.5, 
        x: endPos.x, y: endPos.y, z: endPos.z, 
        onUpdate: () => controls.update(), 
        ease: "power3.inOut",
        
        // --- AQU√ç EST√Å LA MAGIA DE UX ---
        onComplete: () => {
            const card = document.getElementById('info-card');
            const header = card.querySelector('.card-header');

            // 1. Animaci√≥n de "Saltito" (Bounce)
            gsap.fromTo(card, 
                { y: 0 }, 
                { y: -10, duration: 0.3, yoyo: true, repeat: 3, ease: "power1.inOut" }
            );

            // 2. Animaci√≥n de "Resplandor" en el encabezado (Color Pulse)
            // Usamos el color --accent (#00f3ff) pero con transparencia
            gsap.fromTo(header,
                { 
                    backgroundColor: "rgba(255, 255, 255, 0)", // Transparente
                    boxShadow: "0 0 0px rgba(0, 243, 255, 0)" 
                }, 
                { 
                    backgroundColor: "rgba(0, 243, 255, 0.15)", // Cian sutil
                    boxShadow: "0 0 20px rgba(0, 243, 255, 0.3)", // Brillo externo
                    duration: 0.3, 
                    yoyo: true, 
                    repeat: 3,
                    ease: "power1.inOut",
                    onComplete: () => {
                        // Limpieza final para asegurar que quede limpio
                        gsap.to(header, { backgroundColor: "transparent", boxShadow: "none", duration: 0.5 });
                    }
                }
            );
        }
    });
  }

 function showInfoCard(data) {
    document.getElementById('card-title').textContent = data.name;
    document.getElementById('card-desc').textContent = data.desc;
    
    // Configurar enlace con el ID correcto
    document.getElementById('card-link').href = data.url; // `pueblo.html?id=${data.id}`;
    document.getElementById('card-link').target = "_self";

    // Media
    const imgEl = document.getElementById('card-img');
    const videoEl = document.getElementById('card-video');
    const defaultImage = "https://cdn2.ululato.com/img/default.jpeg"; 

    if (data.video) {
        imgEl.style.display = 'none';
        videoEl.style.display = 'block';
        videoEl.src = data.video;
        videoEl.load();
        videoEl.play().catch(e => console.log("Autoplay blocked"));
    } else {
        videoEl.style.display = 'none'; videoEl.pause();
        imgEl.style.display = 'block';
        imgEl.src = data.img ? data.img : defaultImage;
        imgEl.onerror = function() { this.src = defaultImage; };
    }
    
    document.getElementById('info-card').classList.add('active');
  }

  // --- BUSCADOR ---
  const normalizeText = (text) => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : "";
  const searchInput = document.getElementById('searchInput');
  const resultsList = document.getElementById('resultsList');

  searchInput.addEventListener('input', (e) => {
    const term = normalizeText(e.target.value); 
    resultsList.innerHTML = '';
    if (term.length < 1) { resultsList.classList.remove('active'); return; }
    
    const filtered = pueblosData.filter(p => {
        if (p.type !== 'main') return false;
        return normalizeText(p.name).includes(term) || normalizeText(p.region).includes(term);
    });
    
    if (filtered.length > 0) {
      filtered.forEach(p => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `<span class="item-name">${p.name}</span><span class="item-region">${p.region}</span>`;
        div.onclick = () => { searchInput.value = p.name; resultsList.classList.remove('active'); selectPueblo(p.id); };
        resultsList.appendChild(div);
      });
      resultsList.classList.add('active');
    } else { resultsList.classList.remove('active'); }
  });

  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();
  window.addEventListener('click', (e) => {
    if(e.target.closest('.glass-panel') || e.target.closest('.back-link')) return;
    mouse.x = (e.clientX/window.innerWidth)*2-1; mouse.y = -(e.clientY/window.innerHeight)*2+1;
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(markersGroup.children);
    if(hits.length>0 && hits[0].object.userData.id) {
       selectPueblo(hits[0].object.userData.id);
       if(hits[0].object.userData.isMain) searchInput.value = hits[0].object.userData.data.name;
    } else { selectPueblo(null); searchInput.value=''; }
  });

  function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
  
  window.onload = () => {
    setTimeout(()=>{ 
        document.getElementById('loader').style.opacity=0; 
        setTimeout(()=>{document.getElementById('loader').style.display='none'; animate();},800); 
    },1000);
  };
  
  // FIX M√ìVIL
  function fixMobileHeight() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
    document.getElementById('app').style.height = `${window.innerHeight}px`;
  }
  window.addEventListener('resize', () => {
      camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
      fixMobileHeight();
  });
  fixMobileHeight();
</script>
</body>
</html>
