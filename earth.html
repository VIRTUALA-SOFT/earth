<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ULULATO – Earth Experience</title>
  <!-- Fuente Premium: Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- GSAP para animaciones de cine -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <style>
    :root {
      --primary: #ffd700; /* Dorado Premium */
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);
      --glass-blur: blur(12px);
      --text-main: #ffffff;
      --text-secondary: #aaaaaa;
    }

    body { margin: 0; overflow: hidden; background: #020205; font-family: 'Montserrat', sans-serif; }
    
    /* --- UI LAYOUT --- */
    #app { position: relative; width: 100vw; height: 100vh; }
    #globe { width: 100%; height: 100%; display: block; }

    /* --- GLASS PANELS COMUNES --- */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: var(--glass-border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
      color: var(--text-main);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    /* --- PANEL IZQUIERDO (MENU) --- */
    #ui-controls {
      position: absolute;
      top: 40px;
      left: 40px;
      width: 300px;
      z-index: 10;
    }

    h1 {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin: 0 0 4px 0;
      color: var(--primary);
    }
    
    p.subtitle {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
      font-weight: 300;
    }

    /* --- CUSTOM DROPDOWN --- */
    .custom-select-wrapper {
      position: relative;
      user-select: none;
    }
    .custom-select {
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .custom-select__trigger {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      font-size: 0.9rem;
      font-weight: 400;
      color: #fff;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .custom-select__trigger:hover { background: rgba(255,255,255,0.15); }
    .arrow { border: solid var(--primary); border-width: 0 2px 2px 0; display: inline-block; padding: 3px; transform: rotate(45deg); transition: 0.3s; margin-left: 10px;}
    .open .arrow { transform: rotate(-135deg); }

    .custom-options {
      position: absolute;
      display: block;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(10, 15, 30, 0.95);
      border: var(--glass-border);
      border-radius: 8px;
      margin-top: 8px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(-10px);
      transition: all 0.3s;
      z-index: 20;
    }
    .custom-select.open .custom-options { opacity: 1; visibility: visible; pointer-events: all; transform: translateY(0); }
    
    .option {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: 0.2s;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .option:last-child { border-bottom: none; }
    .option:hover { background: rgba(255, 215, 0, 0.2); color: var(--primary); }
    .option.selected { color: var(--primary); font-weight: 600; }

    /* --- INFO CARD (DERECHA) --- */
    #info-card {
      position: absolute;
      bottom: 40px;
      right: 40px;
      width: 320px;
      max-width: 80vw;
      transform: translateX(50px);
      opacity: 0;
      pointer-events: none;
      z-index: 10;
    }
    #info-card.active {
      transform: translateX(0);
      opacity: 1;
      pointer-events: all;
    }
    .card-title { font-size: 1.5rem; margin: 0 0 10px 0; color: var(--primary); }
    .card-desc { font-size: 0.9rem; line-height: 1.6; color: #ddd; margin-bottom: 20px; }
    .btn-action {
      display: inline-block;
      padding: 10px 24px;
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      border-radius: 30px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      text-decoration: none;
      transition: 0.3s;
    }
    .btn-action:hover { background: var(--primary); color: #000; }

    /* --- TOOLTIP FLOTANTE --- */
    #tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      white-space: nowrap;
      border: 1px solid #444;
      z-index: 100;
      transform: translate(-50%, -150%); /* Centrado arriba */
    }

    /* --- LOADER --- */
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #020205; z-index: 999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: opacity 0.8s ease;
    }
    .spinner {
      width: 40px; height: 40px; border: 2px solid #333; border-top: 2px solid var(--primary);
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .loader-text { font-size: 0.8rem; letter-spacing: 3px; text-transform: uppercase; color: #666; }

    /* Responsive */
    @media (max-width: 768px) {
      #ui-controls { top: 20px; left: 20px; width: calc(100% - 40px); }
      #info-card { bottom: 20px; right: 20px; left: 20px; width: auto; }
    }
  </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="spinner"></div>
  <div class="loader-text">Inicializando Universo</div>
</div>

<!-- TOOLTIP 3D -->
<div id="tooltip"></div>

<!-- APP -->
<div id="app">
  
  <!-- PANEL IZQUIERDO -->
  <div id="ui-controls" class="glass-panel">
    <h1>Ululato</h1>
    <p class="subtitle">Explora los pueblos de origen</p>
    
    <div class="custom-select-wrapper">
      <div class="custom-select">
        <div class="custom-select__trigger">
          <span id="select-label">Rotación Libre</span>
          <div class="arrow"></div>
        </div>
        <div class="custom-options">
          <span class="option selected" data-value="">Rotación Libre</span>
          <span class="option" data-value="arhuaco">Arhuaco (Sierra Nevada)</span>
          <span class="option" data-value="wayuu">Wayuu (La Guajira)</span>
          <span class="option" data-value="embera">Emberá (Chocó)</span>
        </div>
      </div>
    </div>
  </div>

  <!-- TARJETA DE INFORMACIÓN (DINÁMICA) -->
  <div id="info-card" class="glass-panel">
    <h2 class="card-title" id="card-title">Título</h2>
    <p class="card-desc" id="card-desc">Descripción corta del pueblo...</p>
    <a href="#" id="card-link" class="btn-action">Explorar Cultura</a>
    <button id="close-card" style="background:none; border:none; color:#666; float:right; cursor:pointer; margin-top:10px;">Cerrar</button>
  </div>

  <!-- CANVAS 3D -->
  <div id="globe"></div>
</div>

<!-- Import Three.js -->
<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
</script>

<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

  // --- CONFIGURACIÓN Y DATOS ---
  const pueblos = {
    arhuaco: { 
      name: "Arhuaco", 
      lat: 10.8, lon: -73.7, 
      desc: "Guardianes de la Sierra Nevada de Santa Marta, el corazón del mundo. Su filosofía se basa en el cuidado de la naturaleza.",
      url: "/ululato/arhuaco" 
    },
    wayuu: { 
      name: "Wayuu",   
      lat: 12.1, lon: -72.2, 
      desc: "Habitantes de la península de La Guajira. Conocidos por sus tejidos coloridos y su fuerte conexión con los sueños.",
      url: "/ululato/wayuu" 
    },
    embera: { 
      name: "Emberá",  
      lat: 5.5,  lon: -76.6, 
      desc: "Pueblo de río y montaña en el Pacífico colombiano. Maestros de la artesanía en chaquira y la pintura corporal con jagua.",
      url: "/ululato/embera" 
    }
  };

  const container = document.getElementById("globe");
  const tooltip = document.getElementById("tooltip");

  // --- SCENE SETUP ---
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x020205);
  // Niebla ligera para fundir el horizonte lejano
  scene.fog = new THREE.FogExp2(0x020205, 0.02);

  const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
  camera.position.set(0, 0, 12); // Empezamos lejos para la intro

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  // Tone mapping para mejor luz
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  container.appendChild(renderer.domElement);

  // --- LUCES ---
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.05); // Muy tenue
  scene.add(ambientLight);

  const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
  sunLight.position.set(10, 5, 10);
  scene.add(sunLight);

  // Luz azulada de contra (Rim Light) para efecto cinematográfico
  const rimLight = new THREE.SpotLight(0x4455ff, 5);
  rimLight.position.set(-10, 5, -5);
  rimLight.lookAt(0,0,0);
  scene.add(rimLight);

  // --- ESTRELLAS ---
  function createStars() {
    const starGeo = new THREE.BufferGeometry();
    const count = 4000;
    const positions = new Float32Array(count * 3);
    const colors = new Float32Array(count * 3);

    for (let i = 0; i < count * 3; i+=3) {
      const r = 400 * Math.cbrt(Math.random()); // Distribución esférica
      const theta = Math.random() * 2 * Math.PI;
      const phi = Math.acos(2 * Math.random() - 1);
      
      positions[i] = r * Math.sin(phi) * Math.cos(theta);
      positions[i+1] = r * Math.sin(phi) * Math.sin(theta);
      positions[i+2] = r * Math.cos(phi);

      // Color estrellas: blanco o azul tenue
      const starType = Math.random();
      colors[i] = colors[i+1] = colors[i+2] = starType > 0.9 ? 1 : 0.8; 
    }

    starGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    starGeo.setAttribute('color', new THREE.BufferAttribute(colors, 3));

    const starMat = new THREE.PointsMaterial({
      vertexColors: true,
      size: 0.8,
      sizeAttenuation: true,
      transparent: true,
      opacity: 0.8
    });
    const stars = new THREE.Points(starGeo, starMat);
    scene.add(stars);
  }
  createStars();

  // --- LA TIERRA ---
  const earthGroup = new THREE.Group();
  scene.add(earthGroup);

  const loadingManager = new THREE.LoadingManager();
  const texLoader = new THREE.TextureLoader(loadingManager);

  // URLs de texturas (asegúrate de que existan)
  const earthMap = texLoader.load("textures/2k/2k_earth_daymap.jpg"); 
  const normalMap = texLoader.load("textures/2k/EarthNormal.png");
  const specMap = texLoader.load("textures/2k/EarthSpec.png");

  const earthGeo = new THREE.SphereGeometry(2, 64, 64);
  const earthMat = new THREE.MeshStandardMaterial({
    map: earthMap,
    normalMap: normalMap,
    roughnessMap: specMap, // Usamos specular como roughness inverso (truco)
    roughness: 0.6,
    metalness: 0.1,
  });
  const earth = new THREE.Mesh(earthGeo, earthMat);
  earthGroup.add(earth);

  // --- ATMÓSFERA GLOW ---
  // Un truco premium es usar un shader o un material aditivo
  const atmosGeo = new THREE.SphereGeometry(2.1, 64, 64);
  const atmosMat = new THREE.MeshPhongMaterial({
    color: 0x0088ff,
    transparent: true,
    opacity: 0.15,
    side: THREE.BackSide, // Invertido para efecto halo
    blending: THREE.AdditiveBlending,
    depthWrite: false
  });
  const atmosphere = new THREE.Mesh(atmosGeo, atmosMat);
  atmosphere.scale.set(1.1, 1.1, 1.1);
  scene.add(atmosphere); // Fuera del grupo para que no rote con la tierra y el brillo sea constante

  // --- MARCADORES ---
  const markersGroup = new THREE.Group();
  earthGroup.add(markersGroup);

  function latLonToVector3(lat, lon, radius) {
    const phi = (90 - lat) * (Math.PI / 180);
    const theta = (lon + 180) * (Math.PI / 180);
    const x = -(radius * Math.sin(phi) * Math.cos(theta));
    const z = (radius * Math.sin(phi) * Math.sin(theta));
    const y = (radius * Math.cos(phi));
    return new THREE.Vector3(x, y, z);
  }

  Object.entries(pueblos).forEach(([key, p]) => {
    const pos = latLonToVector3(p.lat, p.lon, 2.01);
    
    // 1. Núcleo del marcador
    const coreGeo = new THREE.SphereGeometry(0.02, 16, 16);
    const coreMat = new THREE.MeshBasicMaterial({ color: 0xffd700 });
    const core = new THREE.Mesh(coreGeo, coreMat);
    core.position.copy(pos);
    
    // 2. Halo pulsante (anillo)
    const ringGeo = new THREE.RingGeometry(0.04, 0.05, 32);
    const ringMat = new THREE.MeshBasicMaterial({ 
      color: 0xffd700, 
      side: THREE.DoubleSide, 
      transparent: true, 
      opacity: 0.8 
    });
    const ring = new THREE.Mesh(ringGeo, ringMat);
    ring.position.copy(pos);
    ring.lookAt(new THREE.Vector3(0,0,0)); // Mirar al centro de la tierra para alinearse
    
    // Hitbox invisible para facilitar el click/hover
    const hitGeo = new THREE.SphereGeometry(0.1, 8, 8);
    const hitMat = new THREE.MeshBasicMaterial({ visible: false });
    const hitbox = new THREE.Mesh(hitGeo, hitMat);
    hitbox.position.copy(pos);
    hitbox.userData = { id: key, name: p.name, data: p };

    // Agrupamos visuales
    markersGroup.add(core);
    markersGroup.add(ring);
    markersGroup.add(hitbox);

    // Guardamos referencia en hitbox para animar el anillo
    hitbox.userData.ring = ring;
  });

  // --- CONTROLS ---
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enablePan = false;
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.minDistance = 2.5;
  controls.maxDistance = 15;
  controls.autoRotate = true;
  controls.autoRotateSpeed = 0.5;

  // --- LOGICA DE UI E INTERACCIÓN ---
  let selectedPueblo = null;
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  // Custom Dropdown Logic
  const selectWrapper = document.querySelector('.custom-select');
  const selectTrigger = document.querySelector('.custom-select__trigger');
  const selectLabel = document.getElementById('select-label');
  const options = document.querySelectorAll('.option');

  selectTrigger.addEventListener('click', () => {
    selectWrapper.classList.toggle('open');
  });

  options.forEach(option => {
    option.addEventListener('click', function() {
      selectWrapper.classList.remove('open');
      options.forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      
      const value = this.getAttribute('data-value');
      const text = this.textContent;
      selectLabel.textContent = text;
      
      handleSelection(value);
    });
  });

  // Info Card Elements
  const infoCard = document.getElementById('info-card');
  const cardTitle = document.getElementById('card-title');
  const cardDesc = document.getElementById('card-desc');
  const cardLink = document.getElementById('card-link');
  const closeCardBtn = document.getElementById('close-card');

  closeCardBtn.addEventListener('click', () => {
    infoCard.classList.remove('active');
    handleSelection(""); // Reset rotation
    // Reset dropdown UI text
    selectLabel.textContent = "Rotación Libre";
    options.forEach(o => o.classList.remove('selected'));
    document.querySelector('.option[data-value=""]').classList.add('selected');
  });

  function handleSelection(id) {
    selectedPueblo = id;
    
    if(!id) {
      controls.autoRotate = true;
      infoCard.classList.remove('active');
      // Alejar cámara suavemente
      gsap.to(camera.position, {
        duration: 1.5,
        x: 0, y: 0, z: 6.5,
        ease: "power2.inOut"
      });
      return;
    }

    const p = pueblos[id];
    // Rellenar tarjeta
    cardTitle.textContent = p.name;
    cardDesc.textContent = p.desc;
    cardLink.href = p.url;
    infoCard.classList.add('active');

    focusOnLocation(p.lat, p.lon);
  }

  function focusOnLocation(lat, lon) {
    controls.autoRotate = false;

    // Calculamos la posición deseada de la cámara
    // Queremos que la cámara esté frente al punto
    const targetDist = 3.5; // Zoom in
    const phi = (90 - lat) * (Math.PI / 180);
    const theta = (lon + 180) * (Math.PI / 180);
    
    // En ThreeJS coordenadas esféricas:
    // x = r sin(phi) cos(theta) ... (similar a antes pero convertimos lat/lon a coord camera)
    // Sin embargo, es más fácil rotar la Tierra hacia la cámara fija, o mover la cámara.
    // Para efecto "fly to", mover la cámara es más intuitivo con OrbitControls.
    
    // Convertimos lat/lon a posición cartesiana (donde debería estar la cámara)
    // Nota: El mapa de textura suele tener un offset, ajustamos lon
    // Ajuste empírico: Threejs texture offset suele requerir lon + 270 o similar.
    // Usaremos un método más robusto: Vector unitario del punto
    
    const pVec = latLonToVector3(lat, lon, 1).normalize();
    
    // Posición final de la cámara: pVec * distancia
    const endPos = pVec.clone().multiplyScalar(targetDist);

    // Animamos la cámara usando GSAP
    gsap.to(camera.position, {
      duration: 1.5,
      x: endPos.x,
      y: endPos.y,
      z: endPos.z,
      onUpdate: () => controls.update(), // Importante para que OrbitControls no se rompa
      ease: "power3.inOut"
    });
  }

  // --- EVENTOS MOUSE (HOVER & CLICK 3D) ---
  window.addEventListener('mousemove', onMouseMove);
  window.addEventListener('click', onMouseClick);

  function onMouseMove(event) {
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(markersGroup.children);

    let found = false;
    for(let i=0; i<intersects.length; i++) {
      const obj = intersects[i].object;
      if(obj.userData && obj.userData.name) {
        // Show Tooltip
        tooltip.style.left = event.clientX + 'px';
        tooltip.style.top = event.clientY + 'px';
        tooltip.textContent = obj.userData.name;
        tooltip.style.opacity = 1;
        document.body.style.cursor = 'pointer';
        
        // Highlight effect (scale up ring)
        if(obj.userData.ring) {
           gsap.to(obj.userData.ring.scale, {x:1.5, y:1.5, duration: 0.3});
        }
        
        found = true;
        break;
      }
    }

    if(!found) {
      tooltip.style.opacity = 0;
      document.body.style.cursor = 'default';
      // Reset scales
      markersGroup.children.forEach(child => {
        if(child.geometry.type === 'RingGeometry') {
           // Si no está seleccionado, volver a escala normal (animación loop se encarga del resto)
        }
      });
    }
  }

  function onMouseClick(event) {
    if(event.target.closest('#ui-controls') || event.target.closest('#info-card')) return;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(markersGroup.children);
    
    if(intersects.length > 0) {
      const obj = intersects[0].object;
      if(obj.userData && obj.userData.id) {
        // Update UI Dropdown logic sync
        const id = obj.userData.id;
        const option = document.querySelector(`.option[data-value="${id}"]`);
        if(option) option.click(); // Simulate UI click to keep everything in sync
      }
    }
  }

  // --- ANIMACIÓN LOOP ---
  const clock = new THREE.Clock();

  function animate() {
    requestAnimationFrame(animate);
    const time = clock.getElapsedTime();

    controls.update();
    
    // Animación de los anillos (Pulsar)
    markersGroup.children.forEach(child => {
      if(child.geometry.type === 'RingGeometry') {
        // Onda suave
        const scale = 1 + 0.2 * Math.sin(time * 3);
        // Si no estamos haciendo hover (GSAP controlando), aplicamos pulso
        if(!gsap.isTweening(child.scale)) {
           child.scale.set(scale, scale, scale);
        }
      }
    });

    renderer.render(scene, camera);
  }

  // --- CARGA Y RESIZE ---
  loadingManager.onLoad = () => {
    const loader = document.getElementById('loader');
    loader.style.opacity = 0;
    setTimeout(() => {
        loader.style.display = 'none';
        
        // INTRO ANIMATION (De lejos a cerca)
        gsap.to(camera.position, {
            duration: 2.5,
            z: 6.5,
            ease: "power2.out"
        });

        animate();
    }, 800);
  };

  window.addEventListener("resize", () => {
    const w = window.innerWidth;
    const h = window.innerHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
  });

</script>
</body>
</html>
