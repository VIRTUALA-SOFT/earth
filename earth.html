<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ULULATO ‚Äì Earth Experience</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <style>
    :root {
      --primary: #ffd700;       /* Dorado (Puntos normales) */
      --accent: #00f3ff;        /* Cian El√©ctrico (Seleccionado) */
      --glass-bg: rgba(20, 25, 40, 0.7);
      --glass-border: 1px solid rgba(255, 255, 255, 0.15);
      --glass-blur: blur(16px);
      --text-main: #ffffff;
      --text-secondary: #aaaaaa;
    }

    body { margin: 0; overflow: hidden; background: #020205; font-family: 'Montserrat', sans-serif; }
    #app { position: relative; width: 100vw; height: 100vh; }
    #globe { width: 100%; height: 100%; display: block; }

    /* --- PANELES ESTILO CRISTAL --- */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: var(--glass-border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
      color: var(--text-main);
      transition: all 0.3s ease;
    }

    /* --- UI IZQUIERDA (BUSCADOR) --- */
    #ui-controls {
      position: absolute; top: 40px; left: 40px; width: 320px; z-index: 10;
      display: flex; flex-direction: column; gap: 15px;
    }

    h1 { font-size: 1.2rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin: 0; color: var(--primary); }
    p.subtitle { font-size: 0.85rem; color: var(--text-secondary); margin: 0; font-weight: 300; }

    /* INPUT DE B√öSQUEDA PREMIUM */
    .search-container { position: relative; width: 100%; }
    
    .search-input {
      width: 100%;
      padding: 14px 45px 14px 16px; /* Espacio para icono */
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      font-family: inherit;
      font-size: 0.95rem;
      outline: none;
      box-sizing: border-box;
      transition: 0.3s;
    }
    .search-input:focus {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
    }
    .search-icon {
      position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
      color: var(--text-secondary); pointer-events: none;
    }

    /* LISTA DE RESULTADOS (SCROLLABLE) */
    .results-list {
      max-height: 0; /* Oculto por defecto */
      overflow-y: auto;
      background: rgba(10, 15, 25, 0.95);
      border-radius: 12px;
      margin-top: 5px;
      opacity: 0;
      transition: all 0.3s ease;
    }
    .results-list.active {
      max-height: 300px; /* Altura m√°xima visible */
      opacity: 1;
      border: var(--glass-border);
      padding: 5px 0;
    }
    
    /* Scrollbar personalizado */
    .results-list::-webkit-scrollbar { width: 6px; }
    .results-list::-webkit-scrollbar-track { background: transparent; }
    .results-list::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

    .result-item {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      display: flex; justify-content: space-between; align-items: center;
      transition: 0.2s;
    }
    .result-item:hover { background: rgba(255, 255, 255, 0.1); }
    .result-item.selected { background: rgba(0, 243, 255, 0.15); color: var(--accent); font-weight: 600; }
    .result-item span.region { font-size: 0.75rem; color: #666; text-transform: uppercase; }

    /* --- UI DERECHA (TARJETA INFO) --- */
    #info-card {
      position: absolute; bottom: 40px; right: 40px; width: 340px;
      transform: translateX(50px); opacity: 0; pointer-events: none; z-index: 10;
    }
    #info-card.active { transform: translateX(0); opacity: 1; pointer-events: all; }
    
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .card-title { font-size: 1.4rem; margin: 0; color: var(--accent); }
    .card-close { background: none; border: none; color: #666; cursor: pointer; font-size: 1.2rem; }
    .card-close:hover { color: white; }
    
    .card-desc { font-size: 0.9rem; line-height: 1.6; color: #ddd; margin-bottom: 20px; }
    
    .btn-action {
      display: block; width: 100%; text-align: center;
      padding: 12px 0;
      background: transparent; border: 1px solid var(--accent); color: var(--accent);
      border-radius: 8px; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
      text-decoration: none; transition: 0.3s;
    }
    .btn-action:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }

    /* --- TOOLTIP --- */
    #tooltip {
      position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 6px 12px;
      border-radius: 4px; font-size: 0.8rem; pointer-events: none; opacity: 0;
      border: 1px solid #444; z-index: 100; transform: translate(-50%, -150%);
    }

    /* --- LOADER --- */
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020205; z-index: 999;
      display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s ease;
    }
    .loader-bar { width: 200px; height: 2px; background: #333; margin-top: 20px; position: relative; overflow: hidden; }
    .loader-bar::after {
      content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%; background: var(--primary);
      animation: load 1.5s ease-in-out infinite;
    }
    @keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

    @media (max-width: 768px) {
      #ui-controls { top: 20px; left: 20px; width: calc(100% - 40px); }
      #info-card { bottom: 20px; right: 20px; left: 20px; width: auto; }
    }
  </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div style="font-size: 1.5rem; color: var(--primary); letter-spacing: 5px;">ULULATO</div>
  <div class="loader-bar"></div>
</div>

<div id="tooltip"></div>

<div id="app">
  
  <!-- UI IZQUIERDA: BUSCADOR -->
  <div id="ui-controls" class="glass-panel">
    <div>
      <h1>Or√≠genes</h1>
      <p class="subtitle">Explora la sabidur√≠a ancestral</p>
    </div>
    
    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="Buscar pueblo, regi√≥n...">
      <div class="search-icon">üîç</div>
      <!-- Aqu√≠ se inyectan los resultados -->
      <div id="resultsList" class="results-list"></div>
    </div>
  </div>

  <!-- UI DERECHA: INFO -->
  <div id="info-card" class="glass-panel">
    <div class="card-header">
      <h2 class="card-title" id="card-title">T√≠tulo</h2>
      <button class="card-close" id="close-card">√ó</button>
    </div>
    <p class="card-desc" id="card-desc">Descripci√≥n...</p>
    <a href="#" id="card-link" class="btn-action">Visitar Pueblo</a>
  </div>

  <div id="globe"></div>
</div>

<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
</script>

<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

  // --- 1. BASE DE DATOS (Escalable) ---
  // A√±ad√≠ una clave "region" para facilitar b√∫squedas
  const pueblos = [
    { 
      id: "arhuaco", name: "Arhuaco", region: "Sierra Nevada", 
      lat: 10.8, lon: -73.7, 
      desc: "Los 'Hermanos Mayores'. Guardianes del equilibrio del mundo en los picos nevados del norte.",
      url: "/ululato/arhuaco"
    },
    { 
      id: "wayuu", name: "Wayuu", region: "La Guajira", 
      lat: 12.1, lon: -72.2, 
      desc: "Pueblo del desierto y el mar. Famosos por su sistema de justicia (palabrero) y sus tejidos.",
      url: "/ululato/wayuu"
    },
    { 
      id: "embera", name: "Ember√°", region: "Choc√≥ / Pac√≠fico", 
      lat: 5.5, lon: -76.6, 
      desc: "Habitantes de las selvas h√∫medas y r√≠os. Viven en tambos y son expertos navegantes.",
      url: "/ululato/embera"
    },
    { 
      id: "murui", name: "Murui Muina", region: "Amazonas", 
      lat: -1.5, lon: -71.5, 
      desc: "Gente de centro, hijos del tabaco, la coca y la yuca dulce. Protectores de la selva amaz√≥nica.",
      url: "/ululato/murui"
    },
    // ... Imagina aqu√≠ 500 registros m√°s ...
  ];

  // --- 2. CONFIGURACI√ìN THREE.JS ---
  const container = document.getElementById("globe");
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x020205);
  scene.fog = new THREE.FogExp2(0x020205, 0.03); // Niebla para profundidad

  const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
  camera.position.set(0, 0, 14);

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  container.appendChild(renderer.domElement);

  // Luces
   // Luz Ambiental (Relleno base): Subimos la intensidad para ver texturas
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.4); 
  scene.add(ambientLight);

  // Hemisphere Light (Clave para que no se vea negro):
  // Simula luz del cielo (azulado) y del suelo (oscuro), dando volumen 3D inmediato.
  const hemiLight = new THREE.HemisphereLight(0xddeeff, 0x0f0e0d, 1.0);
  scene.add(hemiLight);

  // Luz del Sol (Principal):
  const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
  // La movemos a Z=20 para que ilumine la cara frontal de la Tierra
  sunLight.position.set(5, 5, 20); 
  scene.add(sunLight);

  // Luz de Contorno (Rim Light) - Mantenemos el efecto ne√≥n trasero
  const rimLight = new THREE.SpotLight(0x00f3ff, 4); 
  rimLight.position.set(-10, 10, -5);
  rimLight.lookAt(0, 0, 0);
  scene.add(rimLight);

  
  // Estrellas
  const starGeo = new THREE.BufferGeometry();
  const starCount = 3000;
  const starPos = new Float32Array(starCount * 3);
  for(let i=0; i<starCount*3; i++) starPos[i] = (Math.random()-0.5) * 600;
  starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
  const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.5, transparent: true, opacity: 0.7}));
  scene.add(stars);

  // --- 3. PLANETA TIERRA ---
  const earthGroup = new THREE.Group();
  scene.add(earthGroup);

  const loader = new THREE.TextureLoader();
  
  // Usamos MeshPhongMaterial en lugar de Standard porque es m√°s f√°cil de iluminar
  // y da un resultado m√°s "brillante" y n√≠tido para globos terr√°queos.
  const earthMat = new THREE.MeshPhongMaterial({
    map: loader.load("https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg"),
    bumpMap: loader.load("https://unpkg.com/three-globe/example/img/earth-topology.png"),
    bumpScale: 0.05,
    specularMap: loader.load("https://unpkg.com/three-globe/example/img/earth-water.png"),
    specular: new THREE.Color(0x222222), // Brillo sutil en los oc√©anos
    shininess: 15,
    color: 0xaaaaaa // Color base gris claro para aclarar la textura si es muy oscura
  });

  const earth = new THREE.Mesh(new THREE.SphereGeometry(2, 64, 64), earthMat);
  earthGroup.add(earth);

  // Atm√≥sfera (Glow) - La hacemos un poco m√°s visible
  const atmos = new THREE.Mesh(
    new THREE.SphereGeometry(2.1, 64, 64),
    new THREE.MeshPhongMaterial({
      color: 0x4488ff, // Azul m√°s claro
      transparent: true, 
      opacity: 0.2,    // Un poco m√°s opaca
      side: THREE.BackSide, 
      blending: THREE.AdditiveBlending,
      depthWrite: false
    })
  );
  scene.add(atmos);

  // --- 4. MARCADORES INTELIGENTES ---
  const markersGroup = new THREE.Group();
  earthGroup.add(markersGroup);

  // Materiales reusables para optimizar
  const matGold = new THREE.MeshBasicMaterial({ color: 0xffd700 });
  const matSelected = new THREE.MeshBasicMaterial({ color: 0x00f3ff }); // CIAN NE√ìN
  const matRing = new THREE.MeshBasicMaterial({ color: 0xffd700, side: THREE.DoubleSide, transparent: true, opacity: 0.7 });

  function latLonToVector3(lat, lon, radius) {
    const phi = (90 - lat) * (Math.PI / 180);
    const theta = (lon + 180) * (Math.PI / 180);
    return new THREE.Vector3(
      -(radius * Math.sin(phi) * Math.cos(theta)),
      (radius * Math.cos(phi)),
      (radius * Math.sin(phi) * Math.sin(theta))
    );
  }

  // Generar marcadores
  pueblos.forEach(p => {
    const pos = latLonToVector3(p.lat, p.lon, 2.01);
    
    // N√∫cleo
    const core = new THREE.Mesh(new THREE.SphereGeometry(0.015, 16, 16), matGold.clone());
    core.position.copy(pos);
    
    // Anillo (Onda)
    const ring = new THREE.Mesh(new THREE.RingGeometry(0.03, 0.04, 32), matRing.clone());
    ring.position.copy(pos);
    ring.lookAt(new THREE.Vector3(0,0,0));

    // Rayo de luz (Beacon) - Inicialmente invisible (escala 0 en Y)
    const beamGeo = new THREE.CylinderGeometry(0.005, 0.005, 1, 8);
    beamGeo.translate(0, 0.5, 0); // Pivote en la base
    const beamMat = new THREE.MeshBasicMaterial({ color: 0x00f3ff, transparent: true, opacity: 0, blending: THREE.AdditiveBlending });
    const beam = new THREE.Mesh(beamGeo, beamMat);
    beam.position.copy(pos);
    beam.lookAt(new THREE.Vector3(0,0,0));
    beam.rotateX(-Math.PI/2); // Apuntar hacia afuera
    beam.scale.set(1, 0, 1); // Altura 0 inicial

    // Hitbox para click f√°cil
    const hit = new THREE.Mesh(new THREE.SphereGeometry(0.08, 8, 8), new THREE.MeshBasicMaterial({visible:false}));
    hit.position.copy(pos);
    hit.userData = { id: p.id, data: p, core, ring, beam }; // Guardamos referencias visuales

    markersGroup.add(core, ring, beam, hit);
  });

  // --- 5. L√ìGICA DE SELECCI√ìN Y COLORES ---
  let currentSelectionId = null;

  function selectPueblo(id) {
    currentSelectionId = id;

    // Actualizamos TODOS los marcadores
    markersGroup.children.forEach(child => {
      // Solo nos interesan los hitboxes que tienen la data completa
      if (child.userData && child.userData.id) {
        const refs = child.userData;
        const isSelected = (refs.id === id);

        if (isSelected) {
          // --- ESTADO SELECCIONADO (CIAN) ---
          refs.core.material.color.setHex(0x00f3ff); // Cambiar a Cian
          refs.ring.material.color.setHex(0x00f3ff);
          refs.ring.material.opacity = 1;
          
          // Efecto de explosi√≥n/crecimiento
          gsap.to(refs.core.scale, { x:2, y:2, z:2, duration: 0.5, ease: "back.out(1.7)" });
          gsap.to(refs.ring.scale, { x:2, y:2, duration: 0.5 });
          
          // Desplegar el rayo de luz (Beacon)
          gsap.to(refs.beam.scale, { y: 1.5, duration: 0.8, ease: "power2.out" }); // Crece hacia el espacio
          gsap.to(refs.beam.material, { opacity: 0.6, duration: 0.3 });

          // Mostrar tarjeta info
          showInfoCard(refs.data);
          
        } else {
          // --- ESTADO NO SELECCIONADO (DIMMED) ---
          refs.core.material.color.setHex(0xffd700); // Volver a Dorado
          refs.ring.material.color.setHex(0xffd700);
          
          // Si hay una selecci√≥n activa, los no seleccionados se aten√∫an
          const dimOpacity = id ? 0.2 : 0.7; 
          refs.ring.material.opacity = dimOpacity;
          
          // Reset escalas
          gsap.to(refs.core.scale, { x:1, y:1, z:1, duration: 0.5 });
          
          // Ocultar rayo
          gsap.to(refs.beam.scale, { y: 0, duration: 0.3 });
          gsap.to(refs.beam.material, { opacity: 0, duration: 0.3 });
        }
      }
    });

    if(!id) {
      controls.autoRotate = true;
      document.getElementById('info-card').classList.remove('active');
    } else {
      controls.autoRotate = false;
      const p = pueblos.find(item => item.id === id);
      focusCamera(p.lat, p.lon);
    }
  }

  function showInfoCard(data) {
    document.getElementById('card-title').textContent = data.name;
    document.getElementById('card-desc').textContent = data.desc;
    document.getElementById('card-link').href = data.url;
    document.getElementById('info-card').classList.add('active');
  }

  function focusCamera(lat, lon) {
    const pVec = latLonToVector3(lat, lon, 1).normalize();
    const targetDist = 4.5; // Zoom
    const endPos = pVec.clone().multiplyScalar(targetDist);
    
    gsap.to(camera.position, {
      duration: 1.5,
      x: endPos.x, y: endPos.y, z: endPos.z,
      onUpdate: () => controls.update(),
      ease: "power3.inOut"
    });
  }

  // --- 6. BUSCADOR (L√ìGICA UX) ---
  const searchInput = document.getElementById('searchInput');
  const resultsList = document.getElementById('resultsList');

  // Filtrado en tiempo real
  searchInput.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    resultsList.innerHTML = ''; // Limpiar

    if (term.length < 1) {
      resultsList.classList.remove('active');
      return; // Si borra todo, ocultar lista
    }

    // Filtrar pueblos
    const filtered = pueblos.filter(p => 
      p.name.toLowerCase().includes(term) || 
      p.region.toLowerCase().includes(term)
    );

    if (filtered.length > 0) {
      filtered.forEach(p => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `<span>${p.name}</span> <span class="region">${p.region}</span>`;
        div.onclick = () => {
          searchInput.value = p.name;
          resultsList.classList.remove('active');
          selectPueblo(p.id);
        };
        resultsList.appendChild(div);
      });
      resultsList.classList.add('active');
    } else {
      resultsList.classList.remove('active');
    }
  });

  // Mostrar lista completa al hacer click en el input vac√≠o
  searchInput.addEventListener('focus', () => {
    if(searchInput.value === "") {
        // Opcional: mostrar todos o los m√°s populares
        // Por ahora lo dejamos vac√≠o para no saturar si hay 500
    }
  });

  // Cerrar tarjeta
  document.getElementById('close-card').addEventListener('click', () => {
    selectPueblo(null);
    searchInput.value = '';
  });

  // --- 7. CONTROLES Y ANIMACI√ìN ---
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.autoRotate = true;
  controls.autoRotateSpeed = 0.5;
  controls.minDistance = 2.5;
  controls.maxDistance = 20;

  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();
  const tooltip = document.getElementById('tooltip');

  // Click en el globo
  window.addEventListener('click', (event) => {
    if(event.target.closest('.glass-panel')) return; // Ignorar clicks en UI

    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    
    // Intersectamos solo con los hitboxes invisibles
    const hits = raycaster.intersectObjects(markersGroup.children);
    if(hits.length > 0) {
      const obj = hits[0].object;
      if(obj.userData && obj.userData.id) {
        selectPueblo(obj.userData.id);
        searchInput.value = obj.userData.data.name; // Sincronizar input
      }
    } else {
        // Click en el espacio vac√≠o -> Deseleccionar
        selectPueblo(null);
        searchInput.value = '';
    }
  });

  // Animaci√≥n Loop
  const clock = new THREE.Clock();
  function animate() {
    requestAnimationFrame(animate);
    const time = clock.getElapsedTime();
    controls.update();

    // Animaci√≥n de los anillos (solo los visibles)
    markersGroup.children.forEach(child => {
        // Animar anillos
      if(child.userData.ring) {
        // Si es el seleccionado, pulsa m√°s r√°pido y grande
        // Si no, pulso lento
      }
    });

    renderer.render(scene, camera);
  }
  
  // Loader
  window.addEventListener('load', () => {
     setTimeout(() => {
       document.getElementById('loader').style.opacity = 0;
       setTimeout(() => { document.getElementById('loader').style.display='none'; animate(); }, 800);
     }, 1000);
  });
  
  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

</script>
</body>
</html>
